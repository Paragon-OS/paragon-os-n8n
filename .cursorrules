# Cursor Rules for Paragon OS n8n Agent

## Test Execution Rules

### 1. Always Run Minimum Scope of Tests
- **NEVER** run all tests unless explicitly requested
- **ALWAYS** run the most specific test that covers the change:
  - Single test file: `vitest run src/tests/integration/simple-start.test.ts`
  - Single test case: `vitest run src/tests/integration/credential-setup.test.ts -t "should start n8n instance"`
  - Specific workflow test: `npm run n8n:test -- -w WorkflowName -t testCase`
- Use `npm run test:select` for interactive test selection
- Prefer targeted test commands:
  - `npm run test:simple` - Quick smoke test (~1 min)
  - `npm run test:credentials` - Credential tests (~2 min)
  - `npm run test:backup-restore` - Backup tests (~34-38s, optimized with container reuse)
  - `npm run test:integration` - All tests (~10 min) - ONLY when necessary

### 2. Always Add Timeouts
- **NEVER** run test commands without explicit timeouts
- **ALWAYS** use timeout flags or ensure commands have built-in timeouts:
  - Vitest: Tests already have 5-minute timeout in `vitest.config.ts`
  - execa commands: **MUST** include `timeout` option (e.g., `timeout: 60000`)
  - Long-running operations: Use appropriate timeouts (2-10 minutes)
  - Integration tests: The `scripts/test-integration.sh` script **automatically** applies timeouts:
    - Simple tests: 3 minutes
    - Credential tests: 5 minutes
    - Backup/restore tests: 15 minutes
    - Full suite: 15 minutes
  - If using `vitest` directly, use `--timeout` flag or ensure test files specify timeouts
- If a command might hang, wrap it with a timeout mechanism
- Default timeout for n8n commands: 2 minutes for execute, no timeout for others (configurable)
- **Note**: On macOS, the `timeout` command may not be available. The script falls back to vitest's built-in timeout in this case.

### 3. Podman Container Management
- **ALWAYS** check for running podman containers before running tests
- **ALWAYS** clean up containers before starting tests:
  ```bash
  # Check for running containers
  podman ps --filter 'name=n8n-test'
  
  # Clean up before tests (RECOMMENDED - uses npm script)
  npm run test:cleanup
  # OR manually:
  podman ps -q --filter 'name=n8n-test' | xargs -r podman stop 2>/dev/null || true
  podman ps -aq --filter 'name=n8n-test' | xargs -r podman rm -f 2>/dev/null || true
  ```
- The test integration script (`scripts/test-integration.sh`) **automatically**:
  - Cleans up containers before starting tests
  - Checks for running containers before test execution
  - Cleans up containers after tests complete (success or failure)
  - Removes containers matching `n8n-test-*` patterns
- If tests hang, first check for orphaned containers: `podman ps -a --filter 'name=n8n-test'`
- Clean up containers after test failures or interruptions
- The script uses `timeout` command if available (Linux), otherwise falls back to vitest's built-in timeout

### 4. Test Command Examples

**Good (minimal scope, timeout, cleanup):**
```bash
# Use npm scripts (RECOMMENDED - handles cleanup and timeout automatically)
npm run test:simple          # Simple test (~1 min, 3 min timeout)
npm run test:credentials     # Credential tests (~2 min, 5 min timeout)
npm run test:backup-restore  # Backup tests (~34-38s, 15 min timeout, optimized)

# Or use test integration script directly (also handles cleanup/timeout)
./scripts/test-integration.sh simple
./scripts/test-integration.sh credentials

# For unit tests (no containers needed)
vitest run src/utils/test-helpers.test.ts

# For specific test case
vitest run src/tests/integration/simple-start.test.ts -t "should start n8n"
```

**Bad (too broad, no timeout check, no cleanup):**
```bash
# DON'T: Running all tests without cleanup
npm run test  # Runs ALL unit tests - too broad

# DON'T: Running integration tests without using the script
vitest run src/tests/integration  # Missing cleanup and timeout

# DON'T: No timeout specified for long operations
execa('n8n', ['execute', ...], { /* no timeout */ })

# DON'T: Running tests without checking for containers first
# Always use npm scripts or test-integration.sh which handle this
```

### 5. When Writing Test Code
- **ALWAYS** include timeout in test definitions: `it('test name', async () => {...}, TEST_TIMEOUTS.WORKFLOW)`
- **ALWAYS** use `TEST_TIMEOUTS` constants from `test-helpers.ts` instead of hardcoded values:
  - `TEST_TIMEOUTS.SIMPLE` - 3 minutes for simple tests
  - `TEST_TIMEOUTS.CREDENTIALS` - 5 minutes for credential tests
  - `TEST_TIMEOUTS.WORKFLOW` - 10 minutes for workflow tests
  - `TEST_TIMEOUTS.INTEGRATION` - 10 minutes (alias for WORKFLOW)
- **ALWAYS** include timeout in execa calls: `execa('command', args, { timeout: 60000 })`
- **ALWAYS** cleanup containers in `afterEach` and `afterAll` hooks
- **ALWAYS** check for podman availability before starting tests
- Use `checkPodmanAvailable()` before container operations
- **For integration/workflow tests with multiple test cases**: Use container reuse pattern with helper functions:
  - Import helpers: `import { setupTestInstance, cleanupTestInstance, resetTestInstance, TEST_TIMEOUTS } from '../../utils/test-helpers'`
  - Start container in `beforeAll` using `setupTestInstance()` (once for all tests)
  - Reset state in `beforeEach` using `resetTestInstance(instance)` (~1-2s)
  - Clean up in `afterAll` using `cleanupTestInstance(instance)` (once after all tests)
  - This reduces test time by 65-77% (from 100-150s to 34-38s for backup-restore tests)

### 6. Debugging Hanging Tests
1. Check for running containers: `podman ps --filter 'name=n8n-test'`
2. Check for stuck processes: `ps aux | grep vitest`
3. Clean up: `npm run test:cleanup`
4. Check logs: `tail -100 /tmp/n8n-tests/test_*.log`
5. Check container logs: `podman logs <container-name>`

## Code Quality Rules

- Use TypeScript strict mode
- Follow existing code style and patterns
- Add proper error handling and logging
- Include JSDoc comments for public functions with:
  - Parameter descriptions
  - Return value descriptions
  - Usage examples for complex functions
  - `@deprecated` tags for legacy functions
- Write tests for new functionality
- Use `TEST_TIMEOUTS` constants instead of hardcoded timeout values
- Prefer container reuse pattern over per-test containers for integration/workflow tests

## Test Performance Optimization

### Container Reuse Pattern (Implemented Dec 2024, Refactored Jan 2025)
Integration and workflow tests use container reuse to reduce execution time by 65-77%:

**Pattern (Recommended):**
```typescript
import { setupTestInstance, cleanupTestInstance, resetTestInstance, TEST_TIMEOUTS } from '../../utils/test-helpers';
import type { N8nInstance } from '../../utils/n8n-podman';

describe('My Test Suite', () => {
  let instance: N8nInstance | null = null;

  beforeAll(async () => {
    instance = await setupTestInstance();
  }, TEST_TIMEOUTS.WORKFLOW);

  afterAll(async () => {
    await cleanupTestInstance(instance);
    instance = null;
  }, TEST_TIMEOUTS.WORKFLOW);

  beforeEach(async () => {
    await resetTestInstance(instance);
  }, TEST_TIMEOUTS.WORKFLOW);

  it('should test something', async () => {
    // Use instance.baseUrl, instance.apiKey, etc.
  }, TEST_TIMEOUTS.WORKFLOW);
});
```

**Benefits:**
- Eliminates repeated container startup (saves 20-30s per test)
- Eliminates repeated DB migrations (saves 3s per test)
- Eliminates repeated credential imports (saves 8s per test)
- State reset is fast (~1-2s vs 20-30s container restart)

**Helper Functions (in `src/utils/test-helpers.ts`):**
- `setupTestInstance(config?)` - Sets up shared n8n instance (checks podman, starts container)
- `cleanupTestInstance(instance)` - Cleans up shared instance (handles null safely)
- `resetTestInstance(instance)` - Resets state between tests (verifies health, clears workflows)
- `TEST_TIMEOUTS` - Standard timeout constants (SIMPLE, CREDENTIALS, WORKFLOW, INTEGRATION)

**Low-Level Utilities (in `src/utils/backup-restore-test.ts`):**
- `resetN8nState(instance)` - Clears workflows, verifies clean state
- `verifyN8nHealth(instance)` - Health check before each test
- `clearAllWorkflows(instance)` - Handles archived workflow deletion

**Performance:**
- Backup/restore tests: 100-150s â†’ 34-38s (65-77% faster)
- All tests pass consistently with proper isolation

**Reference Implementation:**
- See `src/tests/integration/backup-restore.test.ts` for complete example
- See `src/tests/integration/credential-setup.test.ts` for credential test pattern

## Workflow Test Runner

### Using executeWorkflowTest (Recommended)
The `executeWorkflowTest()` function in `src/utils/workflow-test-runner.ts` automatically handles:
- Workflow syncing to n8n
- Test execution via Test Runner workflow
- Result parsing and error handling

**Signature:**
```typescript
executeWorkflowTest(
  workflowName: string,
  testCase: string,
  testData: Record<string, unknown>,
  workflowsDir?: string,
  config?: N8nApiConfig | N8nInstance  // Accepts both types!
): Promise<WorkflowTestResult>
```

**Usage with Container Reuse Pattern:**
```typescript
// Pass instance directly (recommended)
const result = await executeWorkflowTest('MyWorkflow', 'test-case', testData, undefined, instance);

// Or use API config (legacy)
const result = await executeWorkflowTest('MyWorkflow', 'test-case', testData, undefined, { 
  baseURL: instance.baseUrl, 
  apiKey: instance.apiKey 
});
```

**Helper Functions:**
- `buildApiConfigFromInstance(instance)` - Converts N8nInstance to N8nApiConfig
- `syncWorkflow()` - Legacy function (deprecated, use executeWorkflowTest instead)

## File Organization

- Test files: `src/tests/**/*.test.ts`
- Integration tests: `src/tests/integration/`
- Workflow tests: `src/tests/workflows/`
- Utilities: `src/utils/`
  - `test-helpers.ts` - Container lifecycle helpers, timeout constants, test result parsing
  - `workflow-test-runner.ts` - Workflow test execution utilities
  - `backup-restore-test.ts` - Backup/restore test utilities (also exports reusable state management)
  - `n8n-podman.ts` - Podman container management
  - `n8n-api.ts` - n8n API client utilities
- Scripts: `scripts/`
- Test optimization docs: `TEST_OPTIMIZATION_SUMMARY.md`

